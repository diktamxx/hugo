---
title: "正视测试驱动开发（Test-Driven Development，TDD）"
slug: "Test-Driven Development"
categories: ["测试驱动开发（TDD）"]
tags: ["测试驱动开发（TDD）"]
date: "2025-03-24"
cover: "images/cover.png"
thumbnail: "images/cover.png"
summary: "为长期目标而编程。"
---

TDD 的价值不在于加速编码，而是提高代码的可维护性。TDD 的过程会驱使开发者从客户端角度来思考API设计，进而编写更符合需求的代码。这有助于避免过度设计，因为可测试的代码会更加简单和健壮。随着 TDD 的持续进行，最终会得到一套较为全面的测试套件。测试套件能够为修改代码工作带来保护和信心。因为可以利用自动化回归测试来验证修改。能提前暴露问题之余，还避免了低效的端到端测试。最终工作效率会慢慢得到提高，并在各方面形成良性循环。

测试套件本身还是一种契约。它就像 Open API、Async API、GraphQL Schema 或 IDL（Interface Description Language）一样约束着 API 提供者不应该肆意地改变规范，从而保障客户端的稳定性。也就说，TDD 其实一种先“签订合同”再进行编码实现的开发模式。这很科学也很合理，因为能够有效地减少过度设计[^1]。此外，TDD 的编程步幅[^2]并不是固定的，但通常建议不要太大。因为步幅越大，可能引入BUG的机率就越大或越多。但还是得强调，开发者完全可以根据经验来决定步幅大小。因为步幅度影响开发效率，而开发效率在公司项目开发中通常比较重要。

当与[领域驱动设计（DDD）]({{% ref "/posts/从敏捷开发的角度入门领域驱动设计/index.md" %}})结合时，因为 TDD 会切实地基于客户端角度来编写代码，这可能会令到开发者需要重新审视先前设计好的领域模型。该问题没有标准的答案，但应该得到重视。个人见解，应该尽可能遵循领域模型的设计。因为领域模型表达的是领域业务，其本身并不涉及技术成分，所以不应该单纯为了编码理由而改变领域模型。这里衍生出另一个问题“是否应该完全依赖 TDD 来进行代码设计？”。答案是否定的。因为重构本身并不会改变外部行为[^3]，所以有关领域概念的抽象、关系和交互等都需要提前进行设计和定义。

TDD 并非灵丹妙药，它并不适合所有场景。特别是在面对一次性代码[^4]、需求不明确或不稳定，以及需要快速开发系统原型的时候，TDD 很可能会拖慢进度。另外，与性能相关的场景也不太适合。因为性能优化相关操作通常无法遵循良好设计，甚至可能大幅度降低代码的可读性（这也是为什么包括我在内的一些人极度不提倡过早优化的原因）。最后值得一提，不要死脑筋认为 TDD 必须在整个项目中使用。其实完全可以仅在关心代码质量的地方使用。

## 参考资料
- 《测试驱动开发：实战与模式解析》Kent Beck
- 《匠艺整洁之道：程序员的职业素养》Robert C. Martin
- [TDD Revisited - Ian Cooper - NDC Porto 2023](https://www.youtube.com/watch?v=IN9lftH0cJc)

[^1]: 过度设计是软件工程中最糟糕的实践。不但会浪费公司资源（引入毫无必要的成本），还会对维护代码的人造成各种负担。
[^2]: 编程步幅是指为恢复测试通过而编写的代码量。
[^3]: Martin Folwer 在《重构》一书中对重构这一概念给出的定义是：在不改变软件外部行为的前提下，改进其内部结构的过程。但至于何谓“外部”，则需要似乎于重构的目标而定。譬如当重构一个方法时，方法的签名应该是保持不变的。否则就该过程就不是重构，而是重新实现。换句话说，此时方法签名就是内部和外部的边界。若重构目标是一个 REST API，那么只需确保 API 规范本身没有被破坏即可。 
[^4]: 一次性代码指代那些不需要后期维护的代码或系统。因为不需要承担维护责任，所以事情会变得无关紧要。但讽刺的是当下很多人用对待一次性代码的态度来对待需要长期维护的项目。